global._ = require('lodash');

jest.dontMock('../quote_mixin');


/**
 * If you change quote/invoice logic and these tests failed, follow these steps to rebuild the tests:
 * 1. If you didn't change item_templates table, skip to step 4.
 * 2. Make sure you have the latest item_templates table in your dev DB.
 * 3. Do a `console.log(JSON.stringify(ItemTemplateStore.getAll()));` to print out the templates array; replace the templates var below with it.
 * 4. Create an ocean quote and an air quote for a shipment in your dev-core.flexport, enter as many items as you need to cover all the business logic cases.
 * 5. Check with products/accounting people to make sure your logic returns the correct total price.
 * 6. Print out your test case with:
 * ```
 * console.log(JSON.stringify(quoteRequest.calculated_weight, quoteRequest.calculated_volume, quoteRequest.chargeable_weight, quoteRequest.chargeable_volume));
 * console.log(JSON.stringify(quote.items));
 * ```
 * 7. Replace the values in the total price test cases with yours.
 * 8. Replace the expected values in the total price tests with your values.
 */
describe('quote calculations', function() {
  var decimals = 7;
  var templates = [{"id":1,"item":"Air Freight","category":"freight","rate_type":"weight","viewable_state":15,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":1,"name":"Air Freight"},{"id":10,"item":"Airline Terminal","category":"origin","rate_type":"weight","viewable_state":15,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":10,"name":"Airline Terminal"},{"id":14,"item":"Airline Terminal (ISC)","category":"destination","rate_type":"total","viewable_state":15,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":14,"name":"Airline Terminal (ISC)"},{"id":11,"item":"Automated Manifest System","category":"origin","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":11,"name":"Automated Manifest System"},{"id":46,"item":"Automated Manifest System","category":"origin","rate_type":"total","viewable_state":15,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":46,"name":"Automated Manifest System"},{"id":92,"item":"CPSC Charge","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":"90.0","default_markup":"10.0","service_type":"Shipment","order":null,"value":92,"name":"CPSC Charge"},{"id":88,"item":"CPSC Charge","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":"90.0","default_markup":"10.0","service_type":"Shipment","order":null,"value":88,"name":"CPSC Charge"},{"id":60,"item":"Chassis","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":60,"name":"Chassis"},{"id":86,"item":"Clean Truck Fee","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":86,"name":"Clean Truck Fee"},{"id":8,"item":"Container Freight Station (CFS)","category":"origin","rate_type":"weight","viewable_state":9,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":8,"name":"Container Freight Station (CFS)"},{"id":55,"item":"Container Freight Station (CFS)","category":"destination","rate_type":"volume","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":55,"name":"Container Freight Station (CFS)"},{"id":43,"item":"Container Freight Station (CFS)","category":"origin","rate_type":"weight","viewable_state":9,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":43,"name":"Container Freight Station (CFS)"},{"id":77,"item":"Container Freight Station (Total)","category":"origin","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":77,"name":"Container Freight Station (Total)"},{"id":82,"item":"Container Freight Station (Total)","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":82,"name":"Container Freight Station (Total)"},{"id":101,"item":"Credit Card Surcharge","category":"additional","rate_type":"total","viewable_state":0,"air":null,"allow_duplicates":true,"default_rate":null,"default_markup":"0.0","service_type":null,"order":null,"value":101,"name":"Credit Card Surcharge"},{"id":97,"item":"Customs Bond","category":"customs","rate_type":"total","viewable_state":0,"air":null,"allow_duplicates":false,"default_rate":"250.0","default_markup":"0.0","service_type":"Client","order":null,"value":97,"name":"Customs Bond"},{"id":42,"item":"Customs Clearance","category":"origin","rate_type":"total","viewable_state":9,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":42,"name":"Customs Clearance"},{"id":29,"item":"Customs Clearance","category":"destination","rate_type":"total","viewable_state":15,"air":true,"allow_duplicates":false,"default_rate":"99.0","default_markup":"0.0","service_type":"Shipment","order":null,"value":29,"name":"Customs Clearance"},{"id":7,"item":"Customs Clearance","category":"origin","rate_type":"total","viewable_state":9,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":7,"name":"Customs Clearance"},{"id":69,"item":"Customs Clearance","category":"destination","rate_type":"total","viewable_state":15,"air":false,"allow_duplicates":false,"default_rate":"99.0","default_markup":"0.0","service_type":"Shipment","order":null,"value":69,"name":"Customs Clearance"},{"id":31,"item":"Customs Duty","category":"customs","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":"0.0","service_type":"Shipment","order":null,"value":31,"name":"Customs Duty"},{"id":72,"item":"Customs Duty","category":"customs","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":"0.0","service_type":"Shipment","order":null,"value":72,"name":"Customs Duty"},{"id":41,"item":"Customs Permit & Export License","category":"origin","rate_type":"total","viewable_state":9,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":41,"name":"Customs Permit & Export License"},{"id":6,"item":"Customs Permit & Export License","category":"origin","rate_type":"total","viewable_state":9,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":6,"name":"Customs Permit & Export License"},{"id":62,"item":"Delivery Order","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":62,"name":"Delivery Order"},{"id":22,"item":"Delivery Order","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":22,"name":"Delivery Order"},{"id":33,"item":"Discount","category":"additional","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":33,"name":"Discount"},{"id":74,"item":"Discount","category":"additional","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":74,"name":"Discount"},{"id":61,"item":"Document","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":61,"name":"Document"},{"id":12,"item":"Document","category":"origin","rate_type":"total","viewable_state":15,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":12,"name":"Document"},{"id":50,"item":"Document","category":"origin","rate_type":"total","viewable_state":15,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":50,"name":"Document"},{"id":21,"item":"Document","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":21,"name":"Document"},{"id":18,"item":"Equipment","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":18,"name":"Equipment"},{"id":57,"item":"Equipment","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":57,"name":"Equipment"},{"id":90,"item":"FCC Charge","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":"90.0","default_markup":"10.0","service_type":"Shipment","order":null,"value":90,"name":"FCC Charge"},{"id":94,"item":"FCC Charge","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":"90.0","default_markup":"10.0","service_type":"Shipment","order":null,"value":94,"name":"FCC Charge"},{"id":36,"item":"FCL - 20' Container","category":"freight","rate_type":"total","viewable_state":15,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":36,"name":"FCL - 20' Container"},{"id":37,"item":"FCL - 40' Container","category":"freight","rate_type":"total","viewable_state":15,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":37,"name":"FCL - 40' Container"},{"id":38,"item":"FCL - 40' Container HQ","category":"freight","rate_type":"total","viewable_state":15,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":38,"name":"FCL - 40' Container HQ"},{"id":89,"item":"FDA Charge","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":"90.0","default_markup":"10.0","service_type":"Shipment","order":null,"value":89,"name":"FDA Charge"},{"id":93,"item":"FDA Charge","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":"90.0","default_markup":"10.0","service_type":"Shipment","order":null,"value":93,"name":"FDA Charge"},{"id":19,"item":"Forklift","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":19,"name":"Forklift"},{"id":58,"item":"Forklift","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":58,"name":"Forklift"},{"id":73,"item":"Freight Insurance","category":"additional","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":73,"name":"Freight Insurance"},{"id":32,"item":"Freight Insurance","category":"additional","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":32,"name":"Freight Insurance"},{"id":2,"item":"Fuel Charge","category":"freight","rate_type":"weight","viewable_state":15,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":2,"name":"Fuel Charge"},{"id":24,"item":"Fuel Surcharge","category":"destination","rate_type":"percentage","viewable_state":9,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":"0.0","service_type":"Shipment","order":null,"value":24,"name":"Fuel Surcharge"},{"id":64,"item":"Fuel Surcharge","category":"destination","rate_type":"percentage","viewable_state":10,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":"0.0","service_type":"Shipment","order":null,"value":64,"name":"Fuel Surcharge"},{"id":84,"item":"General Rate Increase","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":84,"name":"General Rate Increase"},{"id":13,"item":"Handling","category":"origin","rate_type":"total","viewable_state":15,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":13,"name":"Handling"},{"id":28,"item":"Handling","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":28,"name":"Handling"},{"id":51,"item":"Handling","category":"origin","rate_type":"total","viewable_state":15,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":51,"name":"Handling"},{"id":68,"item":"Handling","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":68,"name":"Handling"},{"id":70,"item":"Harbor Maintenance Fee","category":"customs","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":"0.0","service_type":"Shipment","order":null,"value":70,"name":"Harbor Maintenance Fee"},{"id":49,"item":"ISF","category":"origin","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":49,"name":"ISF"},{"id":48,"item":"ISF Bond","category":"origin","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":48,"name":"ISF Bond"},{"id":35,"item":"LCL - Ocean Freight","category":"freight","rate_type":"volume","viewable_state":15,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":35,"name":"LCL - Ocean Freight"},{"id":65,"item":"Liftgate & Other Trucking","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":65,"name":"Liftgate & Other Trucking"},{"id":25,"item":"Liftgate & Other Trucking","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":25,"name":"Liftgate & Other Trucking"},{"id":71,"item":"Merchandise Processing Fee","category":"customs","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":"0.0","service_type":"Shipment","order":null,"value":71,"name":"Merchandise Processing Fee"},{"id":30,"item":"Merchandise Processing Fee","category":"customs","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":"0.0","service_type":"Shipment","order":null,"value":30,"name":"Merchandise Processing Fee"},{"id":26,"item":"Messenger Service","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":26,"name":"Messenger Service"},{"id":66,"item":"Messenger Service","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":66,"name":"Messenger Service"},{"id":100,"item":"Other","category":"additional","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":true,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":100,"name":"Other"},{"id":99,"item":"Other","category":"additional","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":true,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":99,"name":"Other"},{"id":98,"item":"Other","category":"additional","rate_type":"total","viewable_state":0,"air":null,"allow_duplicates":true,"default_rate":null,"default_markup":null,"service_type":"Client","order":null,"value":98,"name":"Other"},{"id":20,"item":"Pallet Exchange","category":"destination","rate_type":"pallet","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":20,"name":"Pallet Exchange"},{"id":59,"item":"Pallet Exchange","category":"destination","rate_type":"pallet","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":59,"name":"Pallet Exchange"},{"id":39,"item":"Pickup","category":"origin","rate_type":"weight","viewable_state":9,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":39,"name":"Pickup"},{"id":4,"item":"Pickup","category":"origin","rate_type":"weight","viewable_state":8,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":4,"name":"Pickup"},{"id":23,"item":"Pickup & Delivery","category":"destination","rate_type":"weight","viewable_state":9,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":23,"name":"Pickup & Delivery"},{"id":63,"item":"Pickup & Delivery","category":"destination","rate_type":"weight","viewable_state":10,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":63,"name":"Pickup & Delivery"},{"id":78,"item":"Pickup & Delivery (Total)","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":78,"name":"Pickup & Delivery (Total)"},{"id":83,"item":"Pickup & Delivery (Total)","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":83,"name":"Pickup & Delivery (Total)"},{"id":76,"item":"Pickup (Total)","category":"origin","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":76,"name":"Pickup (Total)"},{"id":79,"item":"Pickup (Total)","category":"origin","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":79,"name":"Pickup (Total)"},{"id":53,"item":"Pier Pass","category":"destination","rate_type":"volume","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":53,"name":"Pier Pass"},{"id":81,"item":"Pier Pass (Total)","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":81,"name":"Pier Pass (Total)"},{"id":85,"item":"Port Congestion Surcharge","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":85,"name":"Port Congestion Surcharge"},{"id":34,"item":"Promotion","category":"additional","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":34,"name":"Promotion"},{"id":75,"item":"Promotion","category":"additional","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":75,"name":"Promotion"},{"id":54,"item":"Security Charge","category":"destination","rate_type":"total","viewable_state":15,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":"0.0","service_type":"Shipment","order":null,"value":54,"name":"Security Charge"},{"id":3,"item":"Security Charge","category":"freight","rate_type":"weight","viewable_state":15,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":"0.0","service_type":"Shipment","order":null,"value":3,"name":"Security Charge"},{"id":15,"item":"Security Charge","category":"destination","rate_type":"total","viewable_state":15,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":"0.0","service_type":"Shipment","order":null,"value":15,"name":"Security Charge"},{"id":67,"item":"Single Entry Bond","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":67,"name":"Single Entry Bond"},{"id":27,"item":"Single Entry Bond","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":27,"name":"Single Entry Bond"},{"id":47,"item":"Telex","category":"origin","rate_type":"total","viewable_state":15,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":47,"name":"Telex"},{"id":45,"item":"Terminal","category":"origin","rate_type":"weight","viewable_state":15,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":45,"name":"Terminal"},{"id":52,"item":"Terminal","category":"destination","rate_type":"total","viewable_state":15,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":52,"name":"Terminal"},{"id":87,"item":"Terminal (Total)","category":"origin","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":87,"name":"Terminal (Total)"},{"id":91,"item":"USDA Charge","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":"90.0","default_markup":"10.0","service_type":"Shipment","order":null,"value":91,"name":"USDA Charge"},{"id":95,"item":"USDA Charge","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":"90.0","default_markup":"10.0","service_type":"Shipment","order":null,"value":95,"name":"USDA Charge"},{"id":44,"item":"Unloading","category":"origin","rate_type":"weight","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":44,"name":"Unloading"},{"id":9,"item":"Unloading","category":"origin","rate_type":"weight","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":9,"name":"Unloading"},{"id":56,"item":"Warehouse & Value-Add","category":"destination","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":56,"name":"Warehouse & Value-Add"},{"id":17,"item":"Warehouse & Value-Add","category":"destination","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":17,"name":"Warehouse & Value-Add"},{"id":5,"item":"Warehouse & Value-add","category":"origin","rate_type":"total","viewable_state":0,"air":true,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":5,"name":"Warehouse & Value-add"},{"id":40,"item":"Warehouse & Value-add","category":"origin","rate_type":"total","viewable_state":0,"air":false,"allow_duplicates":false,"default_rate":null,"default_markup":null,"service_type":"Shipment","order":null,"value":40,"name":"Warehouse & Value-add"}];

  it('calculate cost correctly', function() {
    var subject = require('../quote_mixin');
    var tests = [
      {params: [53, 'weight', 2.3, 3, null], expected: 121.9},
      {params: [53, 'total', 2.3, 3], expected: 53},
      {params: ['153.30', 'volume', 2.3, 123.343], expected: 18908.4819}
    ];

    tests.forEach(function (test) {
      expect(subject.calculateCost.apply(subject, test.params)).toBeCloseTo(test.expected, decimals);
    });
  });

  it('calculate price correctly', function() {
    var subject = require('../quote_mixin');
    var tests = [
      {params: [53, '1.3'], expected: 53.69},
      {params: ['18908.4812', '1.33'], expected: 19159.96}
    ];

    tests.forEach(function (test) {
      expect(subject.calculatePrice.apply(this, test.params)).toBe(test.expected);
    });
  });

  it('calculate total price for air shipment correctly', function() {
    var calculator = require('../quote_mixin');
    var airTestParams = {
      items: [{"id":12106,"template_id":1,"itemizable_id":1312,"rate":"5.0","markup":"10.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Air Freight","cost":"1666.65","price":"1833.32"},{"id":12110,"template_id":12,"itemizable_id":1312,"rate":"123.0","markup":"10.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Document","cost":"123.0","price":"135.3"},{"id":12111,"template_id":13,"itemizable_id":1312,"rate":"123.0","markup":"10.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Handling","cost":"123.0","price":"135.3"},{"id":12113,"template_id":15,"itemizable_id":1312,"rate":"321.0","markup":"0.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Security Charge","cost":"321.0","price":"321.0"},{"id":12112,"template_id":23,"itemizable_id":1312,"rate":"2.5","markup":"10.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Pickup & Delivery","cost":"307.5","price":"338.25"},{"id":12115,"template_id":24,"itemizable_id":1312,"rate":"20.0","markup":"0.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Fuel Surcharge","cost":"67.65","price":"67.65"},{"id":12114,"template_id":29,"itemizable_id":1312,"rate":"99.0","markup":"0.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Customs Clearance","cost":"99.0","price":"99.0"}],
      templates: templates,
      calculatedWeight: 123,
      calculatedVolume: 2,
      chargeableWeight: 333.33,
      chargeableVolume: null,
      pallet: null,
    };

    calculatedTotal = calculator.calculateTotalPrice.apply(calculator, _.values(airTestParams));

    expect(calculatedTotal).toBe(2929.82);
  });

  it('calculate total price for ocean shipment correctly', function() {
    var calculator = require('../quote_mixin');
    var oceanTestParams = {
      items: [{"id":12121,"template_id":35,"itemizable_id":1312,"rate":"233.0","markup":"10.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"LCL - Ocean Freight","cost":"547.55","price":"602.31"},{"id":12122,"template_id":45,"itemizable_id":1312,"rate":"1.0","markup":"20.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Terminal","cost":"2345.0","price":"2814.0"},{"id":12123,"template_id":46,"itemizable_id":1312,"rate":"12.0","markup":"20.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Automated Manifest System","cost":"12.0","price":"14.4"},{"id":12124,"template_id":47,"itemizable_id":1312,"rate":"32.0","markup":"20.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Telex","cost":"32.0","price":"38.4"},{"id":12116,"template_id":52,"itemizable_id":1312,"rate":"122.0","markup":"20.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Terminal","cost":"122.0","price":"146.4"},{"id":12117,"template_id":54,"itemizable_id":1312,"rate":"123.0","markup":"0.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Security Charge","cost":"123.0","price":"123.0"},{"id":12125,"template_id":59,"itemizable_id":1312,"rate":"23.0","markup":"20.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Pallet Exchange","cost":"69.0","price":"82.8"},{"id":12118,"template_id":63,"itemizable_id":1312,"rate":"2.0","markup":"20.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Pickup & Delivery","cost":"4690.0","price":"5628.0"},{"id":12119,"template_id":64,"itemizable_id":1312,"rate":"20.0","markup":"0.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Fuel Surcharge","cost":"1125.6","price":"1125.6"},{"id":12120,"template_id":69,"itemizable_id":1312,"rate":"99.0","markup":"0.0","item_count":1,"itemizable_type":"Quote","freight_partner_id":null,"deleted_at":null,"other_description":null,"frozen_price":null,"service_type":null,"service_id":null,"name":"Customs Clearance","cost":"99.0","price":"99.0"}],
      templates: templates,
      calculatedWeight: 2345,
      calculatedVolume: 0.4,
      chargeableWeight: 2345,
      chargeableVolume: 2.35,
      pallet: 3,
    };

    calculatedTotal = calculator.calculateTotalPrice.apply(calculator, _.values(oceanTestParams));

    expect(calculatedTotal).toBe(10221.60);
  });
});
