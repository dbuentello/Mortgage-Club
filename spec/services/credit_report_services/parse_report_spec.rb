require "rails_helper"

describe CreditReportServices::ParseReport do
  let!(:borrower) { FactoryGirl.create(:borrower) }
  let(:response) do
    # rubocop:disable LineLength
    "<?xml version=\"1.0\" encoding=\"UTF-8\"?><RESPONSE_GROUP MISMOVersionID=\"2.3.1\">\n  <RESPONDING_PARTY _City=\"ALPHARETTA\" _Name=\"EQUIFAX MORTGAGE SOLUTIONS\" _PostalCode=\"30005\" _State=\"GA\" _StreetAddress=\"1505 WINDWARD CONCOURSE\">\n    <CONTACT_DETAIL>\n      <CONTACT_POINT _Type=\"Phone\" _Value=\"770-740-6613\"/>\n    </CONTACT_DETAIL>\n    <CONTACT_DETAIL>\n      <CONTACT_POINT _Type=\"Fax\" _Value=\"770-740-6125\"/>\n    </CONTACT_DETAIL>\n  </RESPONDING_PARTY>\n  <RESPOND_TO_PARTY _City=\"ALPHARETTA\" _Name=\"EMS TEST 2X PURE XML TEST ACCOUNT\" _PostalCode=\"30005\" _State=\"GA\" _StreetAddress=\"1525 WINDWARD CONCOURSE\">\n    <CONTACT_DETAIL _Name=\"req by QTP\"/>\n  </RESPOND_TO_PARTY>\n  <RESPONSE InternalAccountIdentifier=\"999AUTO1\" ResponseDateTime=\"2016-04-28\">\n    <KEY _Name=\"CreditScoreRankPercent_CRV73R15_CRScr0000\" _Value=\"4\"/>\n    <KEY _Name=\"EquifaxBeacon5.0_MinimumValue\" _Value=\"334\"/>\n    <KEY _Name=\"EquifaxBeacon5.0_MaximumValue\" _Value=\"818\"/>\n    <KEY _Name=\"CreditScoreRankPercent_CRV73R15_CRScr0001\" _Value=\"52\"/>\n    <KEY _Name=\"ExperianFairIsaac_MinimumValue\" _Value=\"320\"/>\n    <KEY _Name=\"ExperianFairIsaac_MaximumValue\" _Value=\"844\"/>\n    <KEY _Name=\"CreditScoreRankPercent_CRV73R15_CRScr0002\" _Value=\"92\"/>\n    <KEY _Name=\"FICORiskScoreClassic04_MinimumValue\" _Value=\"309\"/>\n    <KEY _Name=\"FICORiskScoreClassic04_MaximumValue\" _Value=\"839\"/>\n    <KEY _Name=\"TestCaseDescription\" _Value=\"good generates report 1 borrower\"/>\n    <KEY _Name=\"Cost_Center\" _Value=\"1183\"/>\n    <KEY _Name=\"HTMLFile\" _Value=\"false\"/>\n    <KEY _Name=\"EDI\" _Value=\"true\"/>\n    <KEY _Name=\"BranchId\" _Value=\"QTP Branch\"/>\n    <KEY _Name=\"BRANCHID\" _Value=\"QTP RPBranchId\"/>\n    <RESPONSE_DATA>\n      <CREDIT_RESPONSE CreditRatingCodeType=\"Experian\" CreditReportFirstIssuedDate=\"2016-04-28\" CreditReportIdentifier=\"V73R15\" CreditReportLastUpdatedDate=\"2016-04-28\" CreditReportMergeType=\"Blend\" CreditReportType=\"Merge\" CreditResponseID=\"CRV73R15\" MISMOVersionID=\"2.3.1\">\n        <_DATA_INFORMATION>\n          <DATA_VERSION _Name=\"Equifax\" _Number=\"5\"/>\n          <DATA_VERSION _Name=\"Experian\" _Number=\"7\"/>\n          <DATA_VERSION _Name=\"Trans Union\" _Number=\"4\"/>\n        </_DATA_INFORMATION>\n        <CREDIT_BUREAU _City=\"ALPHARETTA\" _DisclaimerText=\"The reporting bureau certifies that; (a) public   records have been checked for tax liens, judgments, foreclosures,   garnishments, bankruptcies, and other legal actions involving the   subject(s) with the results indicated above; or (b) equivalent   information has been obtained through the use of a qualified   public records reporting service with the results indicated   above.  The records of real estate transfers which do not   involve foreclosures may be excluded.     Equifax Credit Services certifies that the information provided   in this report meets the requirements of the U.S. Dept. of HUD,   FHA, VA, USDA, RECD &amp; FSA, Fannie Mae and FHLMC.     The information is confidential and not to be divulged except   as required by PUBLIC LAW 91-508, 93-579, 94-239.\" _Name=\"EQUIFAX MORTGAGE SOLUTIONS\" _PostalCode=\"30005\" _State=\"GA\" _StreetAddress=\"1505 WINDWARD CONCOURSE\">\n          <CONTACT_DETAIL>\n            <CONTACT_POINT _Type=\"Phone\" _Value=\"770-740-6613\"/>\n          </CONTACT_DETAIL>\n          <CONTACT_DETAIL>\n            <CONTACT_POINT _Type=\"Fax\" _Value=\"770-740-6125\"/>\n          </CONTACT_DETAIL>\n        </CREDIT_BUREAU>\n        <CREDIT_REPORT_PRICE _Amount=\"4.33\" _Type=\"Total\"/>\n        <CREDIT_REPOSITORY_INCLUDED _EquifaxIndicator=\"Y\" _ExperianIndicator=\"Y\" _TransUnionIndicator=\"Y\"/>\n        <REQUESTING_PARTY InternalAccountIdentifier=\"999AUTO1\" LenderCaseIdentifier=\"LOANNUMBER4\" _City=\"ALPHARETTA\" _Name=\"EMS TEST 2X PURE XML TEST ACCOUNT\" _PostalCode=\"30005\" _RequestedByName=\"req by QTP\" _State=\"GA\" _StreetAddress=\"1525 WINDWARD CONCOURSE\">\n          <CONTACT_DETAIL _Name=\"req by QTP\"/>\n        </REQUESTING_PARTY>\n        <CREDIT_REQUEST_DATA BorrowerID=\"B1\" CreditReportIdentifier=\"V73R15\" CreditReportRequestActionType=\"Submit\" CreditReportType=\"Merge\" CreditRepositoriesSelectedCount=\"3\" CreditRequestDateTime=\"2016-04-28\" CreditRequestID=\"CreditRequest1\" CreditRequestType=\"Individual\">\n          <CREDIT_REPOSITORY_INCLUDED _EquifaxIndicator=\"Y\" _ExperianIndicator=\"Y\" _TransUnionIndicator=\"Y\"/>\n        </CREDIT_REQUEST_DATA>\n        <BORROWER BorrowerID=\"B1\" MaritalStatusType=\"Unknown\" _FirstName=\"ROBERT\" _LastName=\"ICE\" _PrintPositionType=\"Borrower\" _SSN=\"301-42-3221\">\n          <_RESIDENCE BorrowerResidencyType=\"Current\" _City=\"ATLANTA\" _PostalCode=\"30014\" _State=\"GA\" _StreetAddress=\"126 4TH ST\"/>\n        </BORROWER>\n        <CREDIT_LIABILITY BorrowerID=\"B1\" CreditBusinessType=\"Finance\" CreditFileID=\"B-EFX-01\" CreditLiabilityID=\"TRD0000\" CreditLoanType=\"RealEstateSpecificTypeUnknown\" CreditTradeReferenceID=\"CTR0000\" _AccountIdentifier=\"1234561421105\" _AccountOpenedDate=\"2000-08\" _AccountOwnershipType=\"Individual\" _AccountReportedDate=\"2016-04\" _AccountStatusDate=\"2016-04\" _AccountStatusType=\"Open\" _AccountType=\"Mortgage\" _ConsumerDisputeIndicator=\"N\" _DerogatoryDataIndicator=\"N\" _HighBalanceAmount=\"134000\" _HighCreditAmount=\"134000\" _LastActivityDate=\"2016-04\" _MonthlyPaymentAmount=\"1404\" _MonthsReviewedCount=\"84\" _TermsDescription=\"MONTHLY\" _TermsSourceType=\"Provided\" _UnpaidBalanceAmount=\"134000\">\n          <_CREDITOR _City=\"PLANO\" _Name=\"GREENP MTG\" _PostalCode=\"75024\" _State=\"TX\" _StreetAddress=\"7933 PRESTON RD MAIL CODE 310630110\">\n            <CONTACT_DETAIL>\n              <CONTACT_POINT _Type=\"Phone\" _Value=\"7066496700\"/>\n            </CONTACT_DETAIL>\n          </_CREDITOR>\n          <_CURRENT_RATING _Code=\"1\" _Type=\"AsAgreed\"/>\n          <_LATE_COUNT _30Days=\"0\" _60Days=\"0\" _90Days=\"0\"/>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>CONVENTIONAL MORTGAGE</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>REAL ESTATE MORTGAGE</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_REPOSITORY _SourceType=\"Equifax\" _SubscriberCode=\"822FM00288\"/>\n        </CREDIT_LIABILITY>\n        <CREDIT_LIABILITY BorrowerID=\"B1\" CreditBusinessType=\"Banking\" CreditFileID=\"B-EFX-01\" CreditLiabilityID=\"TRD0001\" CreditLoanType=\"RealEstateSpecificTypeUnknown\" CreditTradeReferenceID=\"CTR0001\" _AccountIdentifier=\"36104402555599\" _AccountOpenedDate=\"2000-03\" _AccountOwnershipType=\"Individual\" _AccountReportedDate=\"2016-04\" _AccountStatusDate=\"2016-04\" _AccountStatusType=\"Open\" _AccountType=\"Mortgage\" _ConsumerDisputeIndicator=\"N\" _DerogatoryDataIndicator=\"N\" _HighBalanceAmount=\"69090\" _HighCreditAmount=\"69090\" _LastActivityDate=\"2016-04\" _MonthlyPaymentAmount=\"862\" _MonthsReviewedCount=\"84\" _TermsDescription=\"MONTHLY\" _TermsSourceType=\"Provided\" _UnpaidBalanceAmount=\"65975\">\n          <_CREDITOR _City=\"ATLANTA\" _Name=\"BANKAMERIC\" _PostalCode=\"30302\" _State=\"GA\" _StreetAddress=\"PO BOX 50368\"/>\n          <_CURRENT_RATING _Code=\"1\" _Type=\"AsAgreed\"/>\n          <_LATE_COUNT _30Days=\"0\" _60Days=\"0\" _90Days=\"0\"/>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>CONVENTIONAL MORTGAGE</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>REAL ESTATE MORTGAGE</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_REPOSITORY _SourceType=\"Equifax\" _SubscriberCode=\"401BB02330\"/>\n        </CREDIT_LIABILITY>\n        <CREDIT_LIABILITY BorrowerID=\"B1\" CreditBusinessType=\"DepartmentAndMailOrder\" CreditFileID=\"B-TU-01\" CreditLiabilityID=\"TRD0002\" CreditLoanType=\"ChargeAccount\" CreditTradeReferenceID=\"CTR0002\" _AccountIdentifier=\"2665544304\" _AccountOpenedDate=\"2001-06\" _AccountOwnershipType=\"Individual\" _AccountReportedDate=\"2016-04\" _AccountStatusDate=\"2016-04\" _AccountStatusType=\"Open\" _AccountType=\"Revolving\" _ConsumerDisputeIndicator=\"N\" _CreditLimitAmount=\"1500\" _DerogatoryDataIndicator=\"N\" _HighBalanceAmount=\"1500\" _HighCreditAmount=\"1500\" _LastActivityDate=\"2013-04\" _MonthlyPaymentAmount=\"5\" _MonthsReviewedCount=\"9\" _PastDueAmount=\"0\" _TermsDescription=\"MIN\" _TermsSourceType=\"Provided\" _UnpaidBalanceAmount=\"141\">\n          <_CREDITOR _City=\"MASON\" _Name=\"BURDIN/FDSB\" _PostalCode=\"45040\" _State=\"OH\" _StreetAddress=\"9111 DUKE BLVD\">\n            <CONTACT_DETAIL>\n              <CONTACT_POINT _Type=\"Phone\" _Value=\"8002847049\"/>\n            </CONTACT_DETAIL>\n          </_CREDITOR>\n          <_CURRENT_RATING _Code=\"1\" _Type=\"AsAgreed\"/>\n          <_LATE_COUNT _30Days=\"0\" _60Days=\"0\" _90Days=\"0\"/>\n          <_PAYMENT_PATTERN _Data=\"CCXXXXCCC\" _StartDate=\"2013-04\"/>\n          <CREDIT_REPOSITORY _SourceType=\"TransUnion\" _SubscriberCode=\"D 0635D001\"/>\n        </CREDIT_LIABILITY>\n        <CREDIT_LIABILITY BorrowerID=\"B1\" CreditBusinessType=\"Banking\" CreditFileID=\"B-TU-01\" CreditLiabilityID=\"TRD0003\" CreditLoanType=\"CreditCard\" CreditTradeReferenceID=\"CTR0003\" _AccountIdentifier=\"6783XXXX3041\" _AccountOpenedDate=\"1993-11\" _AccountOwnershipType=\"Individual\" _AccountReportedDate=\"2016-04\" _AccountStatusDate=\"2016-04\" _AccountStatusType=\"Open\" _AccountType=\"Revolving\" _ConsumerDisputeIndicator=\"N\" _CreditLimitAmount=\"5400\" _DerogatoryDataIndicator=\"N\" _HighBalanceAmount=\"5400\" _HighCreditAmount=\"5400\" _LastActivityDate=\"2013-04\" _MonthsReviewedCount=\"48\" _PastDueAmount=\"0\" _TermsDescription=\"MONTHLY\" _UnpaidBalanceAmount=\"0\">\n          <_CREDITOR _City=\"SIOUX FALLS\" _Name=\"CITI\" _PostalCode=\"57117\" _State=\"SD\" _StreetAddress=\"POB 6241\">\n            <CONTACT_DETAIL>\n              <CONTACT_POINT _Type=\"Phone\" _Value=\"8008430777\"/>\n            </CONTACT_DETAIL>\n          </_CREDITOR>\n          <_CURRENT_RATING _Code=\"1\" _Type=\"AsAgreed\"/>\n          <_LATE_COUNT _30Days=\"0\" _60Days=\"0\" _90Days=\"0\"/>\n          <_PAYMENT_PATTERN _Data=\"CCCCCCCCCCCCCCCCCCCCXCCCCCCCCCCCCCCCCCCXCCCC\" _StartDate=\"2013-04\"/>\n          <CREDIT_REPOSITORY _SourceType=\"TransUnion\" _SubscriberCode=\"B 064DB002\"/>\n        </CREDIT_LIABILITY>\n        <CREDIT_LIABILITY BorrowerID=\"B1\" CreditBusinessType=\"Finance\" CreditFileID=\"B-EFX-01\" CreditLiabilityID=\"TRD0004\" CreditLoanType=\"RealEstateSpecificTypeUnknown\" CreditTradeReferenceID=\"CTR0004\" _AccountIdentifier=\"6089010\" _AccountOpenedDate=\"1995-05\" _AccountOwnershipType=\"Individual\" _AccountReportedDate=\"2016-04\" _AccountStatusDate=\"2016-04\" _AccountStatusType=\"Open\" _AccountType=\"Mortgage\" _ConsumerDisputeIndicator=\"N\" _DerogatoryDataIndicator=\"N\" _HighBalanceAmount=\"0\" _HighCreditAmount=\"0\" _LastActivityDate=\"2016-04\" _MonthsReviewedCount=\"14\" _TermsDescription=\"MONTHLY\" _UnpaidBalanceAmount=\"0\">\n          <_CREDITOR _City=\"GAITHERSBURG\" _Name=\"CITICORP\" _PostalCode=\"20898\" _State=\"MD\" _StreetAddress=\"PO BOX 9438 DEPT 0251\">\n            <CONTACT_DETAIL>\n              <CONTACT_POINT _Type=\"Phone\" _Value=\"8002837918\"/>\n            </CONTACT_DETAIL>\n          </_CREDITOR>\n          <_CURRENT_RATING _Code=\"1\" _Type=\"AsAgreed\"/>\n          <_LATE_COUNT _30Days=\"0\" _60Days=\"0\" _90Days=\"0\"/>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>REAL ESTATE MORTGAGE</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>ACCOUNT TRANSFERRED OR SOLD</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_REPOSITORY _SourceType=\"Equifax\" _SubscriberCode=\"906FM06418\"/>\n        </CREDIT_LIABILITY>\n        <CREDIT_LIABILITY BorrowerID=\"B1\" CreditBusinessType=\"Banking\" CreditFileID=\"B-XPN-01\" CreditLiabilityID=\"TRD0005\" CreditLoanType=\"ChargeAccount\" CreditTradeReferenceID=\"CTR0005\" _AccountIdentifier=\"603259997000\" _AccountOpenedDate=\"1996-06\" _AccountOwnershipType=\"Individual\" _AccountReportedDate=\"2001-08\" _AccountStatusDate=\"2001-08\" _AccountStatusType=\"Open\" _AccountType=\"Revolving\" _ConsumerDisputeIndicator=\"N\" _CreditLimitAmount=\"500\" _DerogatoryDataIndicator=\"N\" _HighBalanceAmount=\"500\" _HighCreditAmount=\"500\" _MonthsReviewedCount=\"17\" _TermsDescription=\"MONTHLY\" _UnpaidBalanceAmount=\"0\">\n          <_CREDITOR _City=\"NEWARK\" _Name=\"CITIFINANCIAL RETAIL\" _PostalCode=\"19714\" _State=\"DE\" _StreetAddress=\"PO BOX 6080\">\n            <CONTACT_DETAIL>\n              <CONTACT_POINT _Type=\"Phone\" _Value=\"3024545616\"/>\n            </CONTACT_DETAIL>\n          </_CREDITOR>\n          <_CURRENT_RATING _Code=\"1\" _Type=\"AsAgreed\"/>\n          <_LATE_COUNT _30Days=\"0\" _60Days=\"0\" _90Days=\"0\"/>\n          <_PAYMENT_PATTERN _Data=\"CCCCCCCCCCXXXCCCC\" _StartDate=\"2001-08\"/>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>OPEN</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>CURRENT ACCOUNT</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>LAST PAID:</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_REPOSITORY _SourceType=\"Experian\" _SubscriberCode=\"1138180\"/>\n        </CREDIT_LIABILITY>\n        <CREDIT_LIABILITY BorrowerID=\"B1\" CreditBusinessType=\"DepartmentAndMailOrder\" CreditFileID=\"B-TU-01\" CreditLiabilityID=\"TRD0006\" CreditLoanType=\"ChargeAccount\" CreditTradeReferenceID=\"CTR0006\" _AccountIdentifier=\"153211234567\" _AccountOpenedDate=\"2009-03\" _AccountOwnershipType=\"Individual\" _AccountReportedDate=\"2016-04\" _AccountStatusDate=\"2016-04\" _AccountStatusType=\"Open\" _AccountType=\"Revolving\" _ConsumerDisputeIndicator=\"N\" _CreditLimitAmount=\"500\" _DerogatoryDataIndicator=\"N\" _HighBalanceAmount=\"500\" _HighCreditAmount=\"500\" _LastActivityDate=\"2013-04\" _MonthsReviewedCount=\"3\" _PastDueAmount=\"0\" _TermsDescription=\"MONTHLY\" _UnpaidBalanceAmount=\"0\">\n          <_CREDITOR _City=\"MASON\" _Name=\"MACYS/GECCCC\" _PostalCode=\"45040\" _State=\"OH\" _StreetAddress=\"9111 DUKE BLVD\">\n            <CONTACT_DETAIL>\n              <CONTACT_POINT _Type=\"Phone\" _Value=\"8002847049\"/>\n            </CONTACT_DETAIL>\n          </_CREDITOR>\n          <_CURRENT_RATING _Code=\"1\" _Type=\"AsAgreed\"/>\n          <_LATE_COUNT _30Days=\"0\" _60Days=\"0\" _90Days=\"0\"/>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>COLLATERAL: BRCL3C DL1532</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_REPOSITORY _SourceType=\"TransUnion\" _SubscriberCode=\"D 0729D015\"/>\n        </CREDIT_LIABILITY>\n        <CREDIT_LIABILITY BorrowerID=\"B1\" CreditBusinessType=\"Finance\" CreditFileID=\"B-EFX-01\" CreditLiabilityID=\"TRD0007\" CreditLoanType=\"RealEstateSpecificTypeUnknown\" CreditTradeReferenceID=\"CTR0007\" _AccountIdentifier=\"83104315\" _AccountOpenedDate=\"1988-01\" _AccountOwnershipType=\"Individual\" _AccountReportedDate=\"2016-04\" _AccountStatusDate=\"2016-04\" _AccountStatusType=\"Closed\" _AccountType=\"Mortgage\" _ConsumerDisputeIndicator=\"N\" _DerogatoryDataIndicator=\"N\" _HighBalanceAmount=\"64600\" _HighCreditAmount=\"64600\" _LastActivityDate=\"2016-04\" _MonthsReviewedCount=\"22\" _TermsDescription=\"MONTHLY\" _UnpaidBalanceAmount=\"0\">\n          <_CREDITOR _City=\"OKLAHOMA CITY\" _Name=\"MIDLAND MG\" _PostalCode=\"73126\" _State=\"OK\" _StreetAddress=\"PO BOX 268959 F  MIDFIRST BANK\">\n            <CONTACT_DETAIL>\n              <CONTACT_POINT _Type=\"Phone\" _Value=\"8006544566\"/>\n            </CONTACT_DETAIL>\n          </_CREDITOR>\n          <_CURRENT_RATING _Code=\"1\" _Type=\"AsAgreed\"/>\n          <_LATE_COUNT _30Days=\"0\" _60Days=\"0\" _90Days=\"0\"/>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>ACCOUNT PAID</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>REAL ESTATE MORTGAGE</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_REPOSITORY _SourceType=\"Equifax\" _SubscriberCode=\"158FM00079\"/>\n        </CREDIT_LIABILITY>\n        <CREDIT_LIABILITY BorrowerID=\"B1\" CreditBusinessType=\"Banking\" CreditFileID=\"B-EFX-01\" CreditLiabilityID=\"TRD0008\" CreditLoanType=\"CreditCard\" CreditTradeReferenceID=\"CTR0008\" _AccountIdentifier=\"7012510104884453\" _AccountOpenedDate=\"2009-04\" _AccountOwnershipType=\"Individual\" _AccountReportedDate=\"2016-04\" _AccountStatusDate=\"2016-04\" _AccountStatusType=\"Open\" _AccountType=\"Revolving\" _ConsumerDisputeIndicator=\"N\" _CreditLimitAmount=\"6700\" _DerogatoryDataIndicator=\"N\" _HighBalanceAmount=\"6700\" _LastActivityDate=\"2016-04\" _MonthsReviewedCount=\"2\" _TermsDescription=\"MONTHLY\" _UnpaidBalanceAmount=\"0\">\n          <_CREDITOR _City=\"THE LAKES\" _Name=\"SEARS\" _PostalCode=\"89163\" _State=\"NV\" _StreetAddress=\"8725 W. SAHARA AVE MC 02 02 03\"/>\n          <_CURRENT_RATING _Code=\"1\" _Type=\"AsAgreed\"/>\n          <_LATE_COUNT _30Days=\"0\" _60Days=\"0\" _90Days=\"0\"/>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>CREDIT CARD</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_COMMENT _SourceType=\"CreditBureau\" _Type=\"BureauRemarks\">\n            <_Text>AMT IN HIGH CREDIT IS CREDIT LIMIT</_Text>\n          </CREDIT_COMMENT>\n          <CREDIT_REPOSITORY _SourceType=\"Equifax\" _SubscriberCode=\"906BB05577\"/>\n        </CREDIT_LIABILITY>\n        <CREDIT_FILE BorrowerID=\"B1\" CreditFileID=\"B-EFX-01\" CreditRepositorySourceType=\"Equifax\" CreditScoreID=\"CRScr0000\">\n          <_ALERT_MESSAGE _CategoryType=\"FACTAAddressDiscrepancy\" _Code=\" \" _Type=\"Other\" _TypeOtherDescription=\"FACTA\">\n            <_Text>FACTA: Address Discrepancy - ADDRESS ELEMENTS WERE UNAVAILABLE OR NOT UTILIZED.</_Text>\n          </_ALERT_MESSAGE>\n          <_BORROWER _FirstName=\"ROBERT\" _LastName=\"ICE\" _SSN=\"301423221\" _UnparsedName=\"ROBERT ICE\">\n            <_ALIAS _FirstName=\"ICE\" _LastName=\"ROBERT\" _UnparsedName=\"ICE ROBERT\"/>\n            <EMPLOYER EmploymentPositionDescription=\"MGR\" _Name=\"MORRELL GROUP\"/>\n            <_UnparsedEmployment>MORRELL GROUP, UNK</_UnparsedEmployment>\n          </_BORROWER>\n          <_VARIATION _Type=\"DifferentAddress\"/>\n        </CREDIT_FILE>\n        <CREDIT_FILE BorrowerID=\"B1\" CreditFileID=\"B-XPN-01\" CreditRepositorySourceType=\"Experian\" CreditScoreID=\"CRScr0001\">\n          <_ALERT_MESSAGE _CategoryType=\"FACTAAddressDiscrepancy\" _Code=\"1\" _Type=\"Other\" _TypeOtherDescription=\"FACTA\">\n            <_Text>FACTA: Address Discrepancy - RPTD VIA A/R TAPE, BUT DIFFERENT FROM INQUIRY.</_Text>\n          </_ALERT_MESSAGE>\n          <_BORROWER _FirstName=\"ROBERT\" _LastName=\"ICE\" _MiddleName=\"R\" _SSN=\"301423221\" _UnparsedName=\"ROBERT R ICE\">\n            <_ALIAS _LastName=\"ICE\" _MiddleName=\"L \" _NameSuffix=\"JR\" _UnparsedName=\"ROBERT L ICE JR\"/>\n            <_ALIAS _LastName=\"ICE\" _NameSuffix=\"JR\" _UnparsedName=\"ROBERT ICE JR\"/>\n            <EMPLOYER CurrentEmploymentStartDate=\"2001-08-01\" EmploymentPositionDescription=\"NO TITLE FROM REPOSITORY\" PreviousEmploymentEndDate=\"2001-08-01\" _Name=\"NASA\"/>\n            <EMPLOYER CurrentEmploymentStartDate=\"2000-06-01\" EmploymentPositionDescription=\"NO TITLE FROM REPOSITORY\" PreviousEmploymentEndDate=\"2000-06-01\" _Name=\"WORK\"/>\n            <_UnparsedEmployment>NASA, 08/01/2001-08/01/2001</_UnparsedEmployment>\n            <_UnparsedEmployment>WORK, 06/01/2000-06/01/2000</_UnparsedEmployment>\n          </_BORROWER>\n          <_VARIATION _Type=\"DifferentName\"/>\n          <_VARIATION _Type=\"DifferentAddress\"/>\n        </CREDIT_FILE>\n        <CREDIT_FILE BorrowerID=\"B1\" CreditFileID=\"B-TU-01\" CreditRepositorySourceType=\"TransUnion\" CreditScoreID=\"CRScr0002\">\n          <_ALERT_MESSAGE _Type=\"TransUnionHAWKAlert\">\n            <_Text>AVAILABLE AND CLEAR</_Text>\n          </_ALERT_MESSAGE>\n          <_BORROWER _BirthDate=\"1959-08-01\" _FirstName=\"ROBERT\" _LastName=\"ICE\" _MiddleName=\"V\" _SSN=\"301423221\" _UnparsedName=\"ROBERT V ICE\">\n            <EMPLOYER CurrentEmploymentStartDate=\"1988-05-01\" EmploymentPositionDescription=\"DISTRIBUTOR\" EmploymentReportedDate=\"1988-05-01\" _City=\"DOWNINGS\" _Name=\"PEPPERIDGE FARM INC\" _State=\"NY\">\n              <VERIFICATION _ByName=\"ICE, ROBERT V\" _Date=\"1988-05-01\" _StatusType=\"Verified\"/>\n            </EMPLOYER>\n            <_UnparsedEmployment>PEPPERIDGE FARM INC, UNK</_UnparsedEmployment>\n          </_BORROWER>\n          <_VARIATION _Type=\"DifferentName\"/>\n          <_VARIATION _Type=\"DifferentAddress\"/>\n          <_VARIATION _Type=\"DifferentBirthDate\"/>\n        </CREDIT_FILE>\n        <CREDIT_SCORE BorrowerID=\"B1\" CreditFileID=\"B-EFX-01\" CreditReportIdentifier=\"V73R15\" CreditRepositorySourceType=\"Equifax\" CreditScoreID=\"CRScr0000\" _Date=\"2009-06-01\" _ModelNameType=\"EquifaxBeacon5.0\" _Value=\"00505\">\n          <_FACTOR _Code=\"00014\" _Text=\"LENGTH OF TIME ACCOUNTS HAVE BEEN ESTABLISHED\"/>\n          <_FACTOR _Code=\"00004\" _Text=\"TOO MANY BANK OR NATIONAL REVOLVING ACCOUNTS\"/>\n          <_FACTOR _Code=\"00005\" _Text=\"TOO MANY ACCOUNTS WITH BALANCES\"/>\n          <_FACTOR _Code=\"00032\" _Text=\"LACK OF RECENT INSTALLMENT LOAN INFORMATION\"/>\n        </CREDIT_SCORE>\n        <CREDIT_SCORE BorrowerID=\"B1\" CreditFileID=\"B-XPN-01\" CreditReportIdentifier=\"V73R15\" CreditRepositorySourceType=\"Experian\" CreditScoreID=\"CRScr0001\" _Date=\"2001-09-12\" _ModelNameType=\"ExperianFairIsaac\" _Value=\"0727\">\n          <_FACTOR _Code=\"08\" _Text=\"TOO MANY INQUIRIES LAST 12 MONTHS \"/>\n          <_FACTOR _Code=\"14\" _Text=\"LENGTH OF TIME ACCOUNTS HAVE BEEN ESTABLISHED \"/>\n          <_FACTOR _Code=\"30\" _Text=\"TIME SINCE MOST RECENT ACCOUNT OPENING IS TOO SHORT \"/>\n          <_FACTOR _Code=\"06\" _Text=\"TOO MANY CONSUMER FINANCE COMPANY ACCOUNTS \"/>\n        </CREDIT_SCORE>\n        <CREDIT_SCORE BorrowerID=\"B1\" CreditFileID=\"B-TU-01\" CreditReportIdentifier=\"V73R15\" CreditRepositorySourceType=\"TransUnion\" CreditScoreID=\"CRScr0002\" _Date=\"2002-04-11\" _ModelNameType=\"FICORiskScoreClassic04\" _Value=\"00809\">\n          <_FACTOR _Code=\"012\" _Text=\"LENGTH OF TIME REVOLVING ACCOUNTS HAVE BEEN ESTABLISHED\"/>\n          <_FACTOR _Code=\"029\" _Text=\"NO RECENT BANKCARD BALANCES\"/>\n          <_FACTOR _Code=\"005\" _Text=\"TOO MANY ACCOUNTS WITH BALANCES\"/>\n        </CREDIT_SCORE>\n        <CREDIT_TRADE_REFERENCE CreditTradeReferenceID=\"CTR0000\" _City=\"PLANO\" _Name=\"GREENP MTG\" _PostalCode=\"75024\" _State=\"TX\" _StreetAddress=\"7933 PRESTON RD MAIL CODE 310630110\">\n          <CONTACT_DETAIL>\n            <CONTACT_POINT _Type=\"Phone\" _Value=\"7066496700\"/>\n          </CONTACT_DETAIL>\n          <CREDIT_REPOSITORY _SourceType=\"Equifax\" _SubscriberCode=\"822FM00288\"/>\n        </CREDIT_TRADE_REFERENCE>\n        <CREDIT_TRADE_REFERENCE CreditTradeReferenceID=\"CTR0001\" _City=\"ATLANTA\" _Name=\"BANKAMERIC\" _PostalCode=\"30302\" _State=\"GA\" _StreetAddress=\"PO BOX 50368\">\n          <CREDIT_REPOSITORY _SourceType=\"Equifax\" _SubscriberCode=\"401BB02330\"/>\n        </CREDIT_TRADE_REFERENCE>\n        <CREDIT_TRADE_REFERENCE CreditTradeReferenceID=\"CTR0002\" _City=\"MASON\" _Name=\"BURDIN/FDSB\" _PostalCode=\"45040\" _State=\"OH\" _StreetAddress=\"9111 DUKE BLVD\">\n          <CONTACT_DETAIL>\n            <CONTACT_POINT _Type=\"Phone\" _Value=\"8002847049\"/>\n          </CONTACT_DETAIL>\n          <CREDIT_REPOSITORY _SourceType=\"TransUnion\" _SubscriberCode=\"D 0635D001\"/>\n        </CREDIT_TRADE_REFERENCE>\n        <CREDIT_TRADE_REFERENCE CreditTradeReferenceID=\"CTR0003\" _City=\"SIOUX FALLS\" _Name=\"CITI\" _PostalCode=\"57117\" _State=\"SD\" _StreetAddress=\"POB 6241\">\n          <CONTACT_DETAIL>\n            <CONTACT_POINT _Type=\"Phone\" _Value=\"8008430777\"/>\n          </CONTACT_DETAIL>\n          <CREDIT_REPOSITORY _SourceType=\"TransUnion\" _SubscriberCode=\"B 064DB002\"/>\n        </CREDIT_TRADE_REFERENCE>\n        <CREDIT_TRADE_REFERENCE CreditTradeReferenceID=\"CTR0004\" _City=\"GAITHERSBURG\" _Name=\"CITICORP\" _PostalCode=\"20898\" _State=\"MD\" _StreetAddress=\"PO BOX 9438 DEPT 0251\">\n          <CONTACT_DETAIL>\n            <CONTACT_POINT _Type=\"Phone\" _Value=\"8002837918\"/>\n          </CONTACT_DETAIL>\n          <CREDIT_REPOSITORY _SourceType=\"Equifax\" _SubscriberCode=\"906FM06418\"/>\n        </CREDIT_TRADE_REFERENCE>\n        <CREDIT_TRADE_REFERENCE CreditTradeReferenceID=\"CTR0005\" _City=\"NEWARK\" _Name=\"CITIFINANCIAL RETAIL\" _PostalCode=\"19714\" _State=\"DE\" _StreetAddress=\"PO BOX 6080\">\n          <CONTACT_DETAIL>\n            <CONTACT_POINT _Type=\"Phone\" _Value=\"3024545616\"/>\n          </CONTACT_DETAIL>\n          <CREDIT_REPOSITORY _SourceType=\"Experian\" _SubscriberCode=\"1138180\"/>\n        </CREDIT_TRADE_REFERENCE>\n        <CREDIT_TRADE_REFERENCE CreditTradeReferenceID=\"CTR0006\" _City=\"MASON\" _Name=\"MACYS/GECCCC\" _PostalCode=\"45040\" _State=\"OH\" _StreetAddress=\"9111 DUKE BLVD\">\n          <CONTACT_DETAIL>\n            <CONTACT_POINT _Type=\"Phone\" _Value=\"8002847049\"/>\n          </CONTACT_DETAIL>\n          <CREDIT_REPOSITORY _SourceType=\"TransUnion\" _SubscriberCode=\"D 0729D015\"/>\n        </CREDIT_TRADE_REFERENCE>\n        <CREDIT_TRADE_REFERENCE CreditTradeReferenceID=\"CTR0007\" _City=\"OKLAHOMA CITY\" _Name=\"MIDLAND MG\" _PostalCode=\"73126\" _State=\"OK\" _StreetAddress=\"PO BOX 268959 F  MIDFIRST BANK\">\n          <CONTACT_DETAIL>\n            <CONTACT_POINT _Type=\"Phone\" _Value=\"8006544566\"/>\n          </CONTACT_DETAIL>\n          <CREDIT_REPOSITORY _SourceType=\"Equifax\" _SubscriberCode=\"158FM00079\"/>\n        </CREDIT_TRADE_REFERENCE>\n        <CREDIT_TRADE_REFERENCE CreditTradeReferenceID=\"CTR0008\" _City=\"THE LAKES\" _Name=\"SEARS\" _PostalCode=\"89163\" _State=\"NV\" _StreetAddress=\"8725 W. SAHARA AVE MC 02 02 03\">\n          <CREDIT_REPOSITORY _SourceType=\"Equifax\" _SubscriberCode=\"906BB05577\"/>\n        </CREDIT_TRADE_REFERENCE>\n        <CREDIT_COMMENT _SourceType=\"Equifax\" _Type=\"BureauRemarks\">\n          <_Text>ADDRESS DISCREPANCY:( ) ADDRESS ELEMENTS WERE UNAVAILABLE OR NOT UTILIZED</_Text>\n        </CREDIT_COMMENT>\n        <CREDIT_COMMENT _SourceType=\"Equifax\" _Type=\"BureauRemarks\">\n          <_Text>CREDIT REPORT SSN: 301423221</_Text>\n        </CREDIT_COMMENT>\n        <CREDIT_COMMENT _SourceType=\"Equifax\" _Type=\"BureauRemarks\">\n          <_Text>CREDIT REPORT SSN CONFIRMED: Y</_Text>\n        </CREDIT_COMMENT>\n        <CREDIT_COMMENT _SourceType=\"Experian\" _Type=\"BureauRemarks\">\n          <_Text>DISPLAYED SSN IS THE SAME AS INQUIRY SSN</_Text>\n        </CREDIT_COMMENT>\n        <CREDIT_COMMENT _SourceType=\"Experian\" _Type=\"BureauRemarks\">\n          <_Text>XPN: FOUND ADDITIONAL SSN 231183812 FOR APPLICANT</_Text>\n        </CREDIT_COMMENT>\n        <CREDIT_COMMENT _SourceType=\"Experian\" _Type=\"BureauRemarks\">\n          <_Text>DISPLAYED SSN IS DIFFERENT THAN THE INQUIRY SSN</_Text>\n        </CREDIT_COMMENT>\n        <CREDIT_COMMENT _SourceType=\"Experian\" _Type=\"BureauRemarks\">\n          <_Text>ADDRESS DISCREPANCY:(1) RPTD VIA A/R TAPE, BUT DIFFERENT FROM INQUIRY</_Text>\n        </CREDIT_COMMENT>\n        <CREDIT_COMMENT _SourceType=\"TransUnion\" _Type=\"BureauRemarks\">\n          <_Text>05 - Exact match between SSN on input and SSN on file</_Text>\n        </CREDIT_COMMENT>\n        <CREDIT_COMMENT _SourceType=\"Equifax\" _Type=\"BureauRemarks\">\n          <_Text>AKA: ICE ROBERT</_Text>\n        </CREDIT_COMMENT>\n        <CREDIT_COMMENT _SourceType=\"Experian\" _Type=\"BureauRemarks\">\n          <_Text>SIMILAR NAME: ROBERT L ICE JR</_Text>\n        </CREDIT_COMMENT>\n        <CREDIT_COMMENT _SourceType=\"Experian\" _Type=\"BureauRemarks\">\n          <_Text>NAME: ROBERT ICE JR</_Text>\n        </CREDIT_COMMENT>\n        <CREDIT_SUMMARY _Name=\"Generic Summary\">\n          <_DATA_SET _Name=\"TotalMortAccounts\" _Value=\"4\"/>\n          <_DATA_SET _Name=\"TotalMortAccountsWithBal\" _Value=\"2\"/>\n          <_DATA_SET _Name=\"TotalMortBalance\" _Value=\"   199975\"/>\n          <_DATA_SET _Name=\"TotalMortPayments\" _Value=\"     2266\"/>\n          <_DATA_SET _Name=\"TotalMort30\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalMort60\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalMort90\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"MortLateDate\" _Value=\"\"/>\n          <_DATA_SET _Name=\"TotalInstAccounts\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalInstAccountsWithBal\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalInstBalance\" _Value=\"        0\"/>\n          <_DATA_SET _Name=\"TotalInstPayments\" _Value=\"        0\"/>\n          <_DATA_SET _Name=\"TotalInst30\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalInst60\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalInst90\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"InstLateDate\" _Value=\"\"/>\n          <_DATA_SET _Name=\"TotalRevolveAccounts\" _Value=\"5\"/>\n          <_DATA_SET _Name=\"TotalRevolveAccountsWithBal\" _Value=\"1\"/>\n          <_DATA_SET _Name=\"TotalRevolveBalance\" _Value=\"      141\"/>\n          <_DATA_SET _Name=\"TotalRevolvePayments\" _Value=\"        5\"/>\n          <_DATA_SET _Name=\"TotalRevolve30\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalRevolve60\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalRevolve90\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"RevolveLateDate\" _Value=\"\"/>\n          <_DATA_SET _Name=\"TotalCollAccounts\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalCollAccountsWithBal\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalCollBalance\" _Value=\"        0\"/>\n          <_DATA_SET _Name=\"TotalCollPayments\" _Value=\"        0\"/>\n          <_DATA_SET _Name=\"TotalColl30\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalColl60\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalColl90\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"CollLateDate\" _Value=\"\"/>\n          <_DATA_SET _Name=\"TotalOtherAccounts\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalOtherAccountsWithBal\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalOtherBalance\" _Value=\"        0\"/>\n          <_DATA_SET _Name=\"TotalOtherPayments\" _Value=\"        0\"/>\n          <_DATA_SET _Name=\"TotalOther30\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalOther60\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalOther90\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"OtherLateDate\" _Value=\"\"/>\n          <_DATA_SET _Name=\"TotalAccounts\" _Value=\"9\"/>\n          <_DATA_SET _Name=\"TotalAccountsWithBal\" _Value=\"3\"/>\n          <_DATA_SET _Name=\"TotalBalance\" _Value=\"   200116\"/>\n          <_DATA_SET _Name=\"TotalPayments\" _Value=\"     2271\"/>\n          <_DATA_SET _Name=\"Total30\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"Total60\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"Total90\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"LateDate\" _Value=\"\"/>\n          <_DATA_SET _Name=\"TotalLiens\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalJudgements\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalForeclosure\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalBankruptcy\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalOtherPr\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalPr\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalPastDue\" _Value=\"0\"/>\n          <_DATA_SET _Name=\"TotalInqs\" _Value=\"0\"/>\n        </CREDIT_SUMMARY>\n      </CREDIT_RESPONSE>\n    </RESPONSE_DATA>\n  </RESPONSE>\n</RESPONSE_GROUP>\n"
    # rubocop:enable LineLength
  end

  it "creates new liabilities" do
    Liability.destroy_all
    expect { described_class.call(borrower, response) }.to change { Liability.count }.by(3)
  end

  it "updates score for credit report" do
    described_class.call(borrower, response)
    expect(CreditReport.last.score).not_to be_nil
  end

  context "with existent credit_report" do
    let!(:credit_report) { FactoryGirl.create(:credit_report, borrower: borrower) }

    it "does not create a new credit report" do
      expect { described_class.call(borrower, response) }.to change { CreditReport.count }.by(0)
    end
  end

  context "with non-existent credit_report" do
    it "creates a new credit report" do
      expect { described_class.call(borrower, response) }.to change { CreditReport.count }.by(1)
    end
  end

  describe ".get_liability_attributes" do
    it "returns a hash containing liability's attributes" do
      doc = Nokogiri::XML(response)
      credit_liability = doc.css('CREDIT_LIABILITY').first
      attributes = described_class.get_liability_attributes(credit_liability)

      expect(attributes).to include(:account_type, :payment, :balance, :phone, :name)
    end
  end

  describe ".get_address_attributes" do
    it "returns a hash containing address's attributes" do
      doc = Nokogiri::XML(response)
      credit_liability = doc.css('CREDIT_LIABILITY').first
      attributes = described_class.get_address_attributes(credit_liability)

      expect(attributes).to include(:street_address, :city, :state, :zip)
    end
  end

  describe ".get_credit_score" do
    it "returns a credit score" do
      doc = Nokogiri::XML(response)
      expect(described_class.get_credit_score(doc)).to be_a(Float)
    end
  end

  describe ".duplicate?" do
    let(:credit_report) { FactoryGirl.create(:credit_report, borrower: borrower) }
    before(:each) { @credit_liability = credit_report.liabilities.first }

    context "with non duplicate liability" do
      it "returns false" do
        credit_report.liabilities = []
        expect(
          described_class.duplicate?(credit_report, @credit_liability)
        ).to be_falsey
      end
    end

    context "with duplicate liability" do
      it "returns true" do
        credit_report.reload
        expect(
          described_class.duplicate?(credit_report, @credit_liability)
        ).to be_truthy
      end
    end
  end
end
